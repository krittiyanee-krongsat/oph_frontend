<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deep Sea</title>
    <link rel="stylesheet" href="../css/styles.css"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script type="text/javascript" src="../js/script.js"></script>
</head>
<body class="visitor_page">
    <section class="image">
        <div>
            <img src="../Img/Deep_sea.png" width="107px" height="21px">
        </div>
    </section>
    <section class="page5DSP_V">
        <div class="content">
            <h1>คุณอยากให้บุตรหลานหรือผู้ที่อยู่ภายใต้ การปกครองของคุณทำงานในสายอาชีพใด ในอนาคต?
                (เลือกตอบ 3 ลำดับ)</h1>
            <span>Which professions would you like your children or dependents to pursue in the future?  
                (Choose up to 3 preferences.)</span>
        </div>
    </section>
    <section class="OptionSelect_p5" id="page5Options">
        <div id="checkbox-containerV5" class="check_quest_p5">
        </div>
    </section>
    <section class="next-button-pageDSP">
        <button id="submitButton" onclick="saveSelectionPage5()">
            <span class="span-mother">
              <span>N</span>
              <span>e</span>
              <span>x</span>
              <span>t</span>
            </span>
            <span class="span-mother2">
                <span>O</span>
                <span>k</span>
            </span>
          </button>
    </section>
    <section class="back-button-pageDSP">
      <button class="back" onclick="goBackPageDSP5()">
        <span class="span-mother">
          <span>B</span>
          <span>a</span>
          <span>c</span>
          <span>k</span>
        </span>
        <span class="span-mother2">
            <span>O</span>
            <span>k</span>
       </section>
       <script>
        $(document).ready(function() {
       $.ajax({
           url: 'http://localhost:5000/qa_answers',  // Your server-side script URL
           type: 'GET',
           dataType: 'json',
           success: function(data) {
               var container = $('#checkbox-containerV5');
               container.empty(); // Clear existing checkboxes
    
               // Filter data to include only records with IDs 1 through 8
               var filteredData = data.filter(function(item) {
                   return item.ans_id >= 21 && item.ans_id <= 28;
               });
    
               // Create checkboxes based on filtered data
               $.each(filteredData, function(index, item) {
                   // Assign a unique class based on ans_id
                   var uniqueClass = 'option-' + item.ans_id; // Example: option-1, option-2, etc.
                   var checkbox = $('<input>', {
                       type: 'checkbox',
                       id: 'checkbox' + item.ans_id,
                       value: item.ans_id + '-' + item.qa_id,
                       class: uniqueClass
                   });
    
                   var span = $('<span>', {
                       text: item.answer,
                       class: uniqueClass
                   });
    
                   var label = $('<label>', {
                       for: 'checkbox' + item.ans_id
                   }).append(checkbox).append(span); // Wrap checkbox and span inside label
                   
                       container.append(checkbox).append(label).append('<br>');
                   });
                   
                   $('input[type="checkbox"]').change(function() {
                   var selectedCount = $('input[type="checkbox"]:checked').length;
                   if (selectedCount > 3) {
                       $(this).prop('checked', false); // Uncheck the last clicked checkbox
                       alert('You can select up to 3 options only.');
                   }
               });
           },
               error: function(xhr, status, error) {
                   console.error('Error fetching data:', status, error);
               }
           });
        $('#submitButton').click(function() {
            // Retrieve and combine stored data from localStorage
            var pages = ['selectedOptions_page1', 'selectedOptions_page2', 'selectedOptions_page3', 'selectedOptions_page4', 'selectedOptions_page5'];
            var combinedAnswers = {};
    
            pages.forEach(function(page) {
                var answers = JSON.parse(localStorage.getItem(page)) || [];
                answers.forEach(function(answer) {
                    var [ans_id, qa_id] = answer.split('-'); // Split '1-1' into qa_id and ans_id
                    qa_id = parseInt(qa_id, 10);
                    ans_id = parseInt(ans_id, 10);
    
                    if (!combinedAnswers[qa_id]) {
                        combinedAnswers[qa_id] = [];
                    }
                    combinedAnswers[qa_id].push(ans_id);
                });
            });
    
            // Format data into the required structure
            var anslist = Object.keys(combinedAnswers).map(function(qa_id) {
                return {
                    qa_id: parseInt(qa_id, 10),
                    ans_id: combinedAnswers[qa_id]
                };
            });
    
            var formatJson = {
                user_id: 7, // Replace with actual user ID if needed
                ans_list: anslist
            };
    
            console.log('Formatted JSON:', JSON.stringify(formatJson));
    
            // Send data to server
            $.ajax({
                url: 'http://localhost:5000/qa_transaction', // Your server-side script URL
                method: 'POST',
                dataType: 'json',
                contentType: 'application/json',
                data: JSON.stringify(formatJson),
                success: function(response) {
                    console.log('Success:', response);
                    alert('Data submitted successfully.');
                },
                error: function(xhr, status, error) {
                    console.error('Error:', status, error);
                    alert('Error submitting data.');
                }
            });
            location.replace("../ModelPage/1_ModelPageStart.html")
        });
    });
    
    </script>
</body>
</html>