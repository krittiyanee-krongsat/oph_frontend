<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QA</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

    <div id="questions"></div><br/><br/>
    <button id="submitButton" disabled>Submit</button>

    <script>
        const apiUrl = "https://deepseaoph2024.bu.ac.th/api/";
        const questionsData = [];
        const selectedAnswers = {}; // สำหรับเก็บคำตอบที่เลือก

        $(document).ready(function() {
            // ดึงข้อมูลคำถามและคำตอบจากเซิร์ฟเวอร์
            for (let id = 1; id <= 5; id++) {
                $.ajax({
                    url: `${apiUrl}qa_question/${id}`,
                    method: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        questionsData.push(data);
                        if (questionsData.length === 5) {
                            displayQuestions();
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error("AJAX Error: ", status, error);
                    }
                });
            }

            let questionsLoaded = false;

            function displayQuestions() {
                if (questionsLoaded) return;
                questionsLoaded = true;

                const $questions = $("<div></div>");

                questionsData.forEach(questionData => {
                    const questionList = questionData.question_list;
                    const answers = questionData.answers_list[0];

                    questionList.forEach(questionItem => {
                        const $questionContainer = $('<div></div>');

                        // แสดงข้อความคำถาม
                        $questionContainer.append(
                            $('<span></span>').attr('data-id', questionItem.qa_id).text(questionItem.q_student)
                        );

                        // กำหนดประเภทของการป้อนข้อมูลเป็น checkbox หรือ radio
                        const inputType = (questionItem.qa_id === 1 || questionItem.qa_id === 5) ? 'checkbox' : 'radio';

                        answers.forEach(answerItem => {
                            const $label = $('<label></label>');
                            const $input = $(`<input type="${inputType}" name="answer${questionItem.qa_id}">`).val(answerItem.ans_id);

                            $label.append($input).append(answerItem.answer);
                            $questionContainer.append('<br>').append($label);
                        });

                        $questions.append($questionContainer).append('<br>');
                    });
                });

                $('#questions').html($questions);
                enableSubmitButton(); // เรียกฟังก์ชันเพื่อกำหนดสถานะเริ่มต้นของปุ่มส่ง
            }

            function enableSubmitButton() {
                $('#submitButton').prop('disabled', false);
                validateAnswers(); // ตรวจสอบความถูกต้องของคำตอบเบื้องต้น
            }

            function validateAnswers() {
                let valid = true;

                // ตรวจสอบความถูกต้องของคำตอบสำหรับคำถามประเภท checkbox
                $('input[type="checkbox"]').each(function() {
                    const questionId = $(this).attr('name').replace('answer', '');
                    const selectedCount = $(`input[name="answer${questionId}"]:checked`).length;

                    // ถ้าคำถามเป็นประเภท 1 หรือ 5 ต้องเลือกไม่เกิน 3 ตัวเลือก
                    if ((questionId === '1' || questionId === '5') && selectedCount > 3) {
                        valid = false;
                        return false; // ออกจากลูป
                    }
                });

                $('#submitButton').prop('disabled', !valid);
            }

            $('#questions').on('change', 'input[type="checkbox"], input[type="radio"]', function() {
                var questionId = $(this).attr('name').replace('answer', '');
                var selectedAnswer = $('input[name="answer' + questionId + '"]:checked').length;

                if ($(this).is(':checked')) {
                    if (!selectedAnswers[questionId]) {
                        selectedAnswers[questionId] = [];
                    }
                    if (!selectedAnswers[questionId].includes(selectedAnswer)) {
                        selectedAnswers[questionId].push(selectedAnswer);
                    }
                } else {
                    const index = selectedAnswers[questionId].indexOf(selectedAnswer);
                    if (index > -1) {
                        selectedAnswers[questionId].splice(index, 1);
                    }
                }

                validateAnswers();
            });

            $('#submitButton').click(function() {
                const qaArray = [];

                Object.keys(selectedAnswers).forEach(questionId => {
                    const answers = selectedAnswers[questionId];
                    if (answers.length > 0) {
                        const qaAnswers = {
                            'qa_id': questionId,
                            'ans_id': answers
                        };

                        qaArray.push(qaAnswers);
                    }
                });

                const formatJson = {
                    "user_id": 1,
                    "ans_list": qaArray
                };

                console.log(JSON.stringify(formatJson));

                $.ajax({
                    url: `${apiUrl}qa_transaction`,
                    method: 'POST',
                    dataType: 'json',
                    contentType: 'application/json',
                    data: JSON.stringify(formatJson),
                    success: function(response) {
                        console.log(response);
                        alert('Success');
                    },
                    error: function(xhr, status, error) {
                        console.error("AJAX Error: ", status, error);
                        alert('Error');
                    }
                });

                return false;
            });
        });
    </script>
</body>
</html>
