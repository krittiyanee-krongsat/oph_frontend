<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QA</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
    <script> 

        //var apiUrl = "http://localhost:5000/";
        var apiUrl = "https://deepseaoph2024.bu.ac.th/api/";

    </script>
        <body>

            <div id="questions"></div><br/><br/>
            <button id="submitButton">Submit</button>

            <script>

                $(document).ready(function() {

                    var questionsData = [];
                
                    // ดึงข้อมูลคำถามและคำตอบจากเซิร์ฟเวอร์
                    for(let id=1; id <= 5; id++){
                        $.ajax({
                            url: apiUrl+"qa_question/"+id,
                            method: 'GET',
                            dataType: 'json',
                            success: function(data) {
                                questionsData.push(data);
                                if (questionsData.length === 5) {
                                    displayQuestions();
                                }
                            },
                            error: function(xhr, status, error) {
                                console.error("AJAX Error: ", status, error);
                            }
                        });
                    }
                
                    function displayQuestions() {
                        var $questions = $("<div></div>");
                        
                        // จัดเรียงข้อมูลคำถามตาม ID
                        questionsData.sort(function(a, b) {
                            return a.question_list[0].qa_id - b.question_list[0].qa_id;
                        });
                
                        $.each(questionsData, function(index, questionData) {
                            var question_list = questionData.question_list;
                            var answers = questionData.answers_list[0];
                            
                            $.each(question_list, function(index, questionItem) {
                                var $questionContainer = $('<div></div>');
                                
                                // แสดงข้อความคำถาม
                                $questionContainer.append(
                                    $('<span></span>').val(questionItem.qa_id).text(questionItem.q_student)
                                );
                                
                                // กำหนดประเภทของการป้อนข้อมูลเป็น checkbox หรือ radio
                                var inputType = (questionItem.qa_id === 1 || questionItem.qa_id === 5) ? 'checkbox' : 'radio';
                                
                                $.each(answers, function(index, answerItem) {
                                    var $label = $('<label></label>');
                                    var $input = $('<input type="' + inputType + '" name="answer' + questionItem.qa_id + '">').val(answerItem.ans_id);
                                    
                                    $label.append($input).append(answerItem.answer);
                                    $questionContainer.append('<br>').append($label);
                                });
                                
                                $questions.append($questionContainer).append('<br>');
                            });
                        });
                
                        $('#questions').html($questions);
                        enableSubmitButton(); // เรียกฟังก์ชันเพื่อกำหนดสถานะเริ่มต้นของปุ่มส่ง
                    }
                
                    function enableSubmitButton() {
                        $('#submitButton').prop('disabled', false);
                        validateAnswers(); // ตรวจสอบความถูกต้องของคำตอบเบื้องต้น
                    }
                
                    function validateAnswers() {
                        var valid = true;
                
                        // ตรวจสอบความถูกต้องของคำตอบสำหรับคำถามประเภท checkbox
                        $('input[type="checkbox"]').each(function() {
                            var questionId = $(this).attr('name').replace('answer', '');
                            var selectedCount = $('input[name="answer' + questionId + '"]:checked').length;
                            
                            // ถ้าคำถามเป็นประเภท 1 หรือ 5 ต้องเลือกไม่เกิน 3 ตัวเลือก
                            if ((questionId === '1' || questionId === '5') && selectedCount > 3) {
                                valid = false;
                                return false; // ออกจากลูป
                            }
                        });
                
                        $('#submitButton').prop('disabled', !valid);
                    }
                
                    // ฟังก์ชันสำหรับเปลี่ยนแปลงค่าใน checkbox หรือ radio button
                    $('#questions').on('change', 'input[type="checkbox"], input[type="radio"]', function() {
                        validateAnswers();
                    });
                
                    $('#submitButton').click(function() {
                        var qa_array = [];
                        
                        // สร้างอาร์เรย์สำหรับเก็บคำตอบ
                        $('#questions span').each(function() {
                            var questionId = $(this).val();
                            var selectedAnswers = [];
                            
                            $('#questions input[name="answer' + questionId + '"]:checked').each(function() {
                                selectedAnswers.push($(this).val());
                            });
                            
                            if (selectedAnswers.length > 0) {
                                var qa_answers = {
                                    'qa_id': questionId,
                                    'ans_id': selectedAnswers
                                };
                                
                                qa_array.push(qa_answers);
                                console.log(qa_answers);
                            }
                        });
                    
                        var formatJson = {
                            "user_id": user_id,
                            "ans_list": qa_array
                        };
                        
                        console.log(JSON.stringify(formatJson));
                        
                        // ส่งข้อมูลคำตอบไปยังเซิร์ฟเวอร์
                        $.ajax({
                            url: apiUrl+'qa_transaction',
                            method: 'POST',
                            dataType: 'json',
                            contentType: 'application/json',
                            data: JSON.stringify(formatJson)
                        }).always(function (response) {
                            console.log(response);
                            alert('Success');
                        });
                    
                        return false;
                    });            
                });                
                
            </script>
        </body>
</html>










