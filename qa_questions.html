<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QA</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

    <div id="questions"></div><br/><br/>
    <button id="submitButton" disabled>Submit</button>

    <script> 
        //var apiUrl = "http://localhost:5000/";
        var apiUrl = "https://deepseaoph2024.bu.ac.th/api/";

        $(document).ready(function() {
            var questionsData = [];
            var selectedAnswers = {};
        
            // สร้าง array ของ AJAX requests
            var requests = [];
            for(let id = 1; id <= 5; id++){
                requests.push($.ajax({
                    url: apiUrl + "qa_question/" + id,
                    method: 'GET',
                    dataType: 'json'
                }));
            }
        
            // รอให้ทุก requests เสร็จสิ้น
            $.when.apply($, requests).done(function() {
                var responses = arguments;
                $.each(responses, function(index, response) {
                    questionsData.push({ index: index + 1, ...response[0] }); // เพิ่มลำดับในคำถาม
                });
                // จัดลำดับตาม index ก่อนแสดง
                questionsData.sort((a, b) => a.index - b.index);
                displayQuestions();
            }).fail(function(xhr, status, error) {
                console.error("AJAX Error: ", status, error);
            });
        
            function displayQuestions() {
                var $questions = $("<div></div>");
        
                $.each(questionsData, function(index, questionData) {
                    var questionList = questionData.question_list;
                    var answers = questionData.answers_list[0];
        
                    $.each(questionList, function(index, questionItem) {
                        var $questionContainer = $('<div></div>');
                        
                        $questionContainer.append(
                            $('<span></span>').attr('data-id', questionItem.qa_id).text(questionItem.q_student)
                        );
        
                        var inputType = (questionItem.qa_id === 1 || questionItem.qa_id === 5) ? 'checkbox' : 'radio';
                        
                        $.each(answers, function(index, answerItem) {
                            var $label = $('<label></label>');
                            var $input = $('<input type="' + inputType + '" name="answer' + questionItem.qa_id + '">').val(answerItem.ans_id);
        
                            $label.append($input).append(answerItem.answer);
                            $questionContainer.append('<br>').append($label);
                        });
        
                        $questions.append($questionContainer).append('<br>');
                    });
                });
        
                $('#questions').html($questions);
                enableSubmitButton();
            }
        
            function enableSubmitButton() {
                $('#submitButton').prop('disabled', false);
                validateAnswers();
            }
        
            function validateAnswers() {
                var valid = true;
        
                $('input[type="checkbox"]').each(function() {
                    var questionId = $(this).attr('name').replace('answer', '');
                    var selectedCount = $('input[name="answer' + questionId + '"]:checked').length;
                    
                    if ((questionId === '1' || questionId === '5') && selectedCount > 3) {
                        valid = false;
                        return false;
                    }
                });
        
                $('#submitButton').prop('disabled', !valid);
            }
        
            $('#questions').on('change', 'input[type="checkbox"], input[type="radio"]', function() {
                var questionId = $(this).closest('div').find('span').attr('data-id');
                var selectedAnswer = $(this).val();
        
                if ($(this).is(':checked')) {
                    if (!selectedAnswers[questionId]) {
                        selectedAnswers[questionId] = [];
                    }
                    selectedAnswers[questionId].push(selectedAnswer);
                } else {
                    var index = selectedAnswers[questionId].indexOf(selectedAnswer);
                    if (index > -1) {
                        selectedAnswers[questionId].splice(index, 1);
                    }
                }
        
                validateAnswers();
            });
        
            $('#submitButton').click(function() {
                var qa_array = [];
        
                $.each(selectedAnswers, function(questionId, answers) {
                    if (answers.length > 0) {
                        var qa_answers = {
                            'qa_id': questionId,
                            'ans_id': answers
                        };
                        
                        qa_array.push(qa_answers);
                    }
                });
        
                var formatJson = {
                    "user_id": 1,
                    "ans_list": qa_array
                };
        
                console.log(JSON.stringify(formatJson));
        
                $.ajax({
                    url: apiUrl + 'qa_transaction',
                    method: 'POST',
                    dataType: 'json',
                    contentType: 'application/json',
                    data: JSON.stringify(formatJson),
                    success: function(response) {
                        console.log(response);
                        alert('Success');
                    },
                    error: function(xhr, status, error) {
                        console.error("AJAX Error: ", status, error);
                        alert('Error');
                    }
                });
        
                return false;
            });
        });        
    </script>
</body>
</html>













