
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>satisfactionsQA</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
    <script> 
            
        //var apiUrl = "http://localhost:5000/";
        var apiUrl = "https://deepseaoph2024.bu.ac.th/api/";

    </script>
        <body>

            <div id="satisfactions_q"></div><br/><br/>
            <button id="submitButton">Submit</button>

            <script>
                $(document).ready(function() {

                    var satisfactionsData = [];

                    // ดึงข้อมูลคำถามและคำตอบจากเซิร์ฟเวอร์
                    for(let id=1; id <= 7; id++){
                        $.ajax({
                            url: apiUrl+"satisfaction_q/"+id,
                            method: 'GET',
                            dataType: 'json',
                            success: function(data) {
                                satisfactionsData.push(data);
                                if (satisfactionsData.length === 7) {
                                    displaySatisfaction();
                                }
                            },
                            error: function(xhr, status, error) {
                                console.error("AJAX Error: ", status, error);
                            }
                        });
                    }
                
                    function displayQuestions() {
                        var $questions = $("<div></div>");
                    
                        // Sort questionsData by qa_id to ensure correct order
                        questionsData.sort(function(a, b) {
                            return a.question_list[0].qa_id - b.question_list[0].qa_id;
                        });
                    
                        $.each(questionsData, function(index, questionData) {
                            var question_list = questionData.question_list;
                            var answers = questionData.answers_list[0];
                    
                            $.each(question_list, function(index, questionItem) {
                                var $questionContainer = $('<div></div>');
                    
                                // Show question text
                                $questionContainer.append(
                                    $('<span></span>').val(questionItem.qa_id).text(questionItem.q_student)
                                );
                    
                                // Set input type to checkbox or radio
                                var inputType = (questionItem.qa_id === 1 || questionItem.qa_id === 5) ? 'checkbox' : 'radio';
                    
                                $.each(answers, function(index, answerItem) {
                                    var $label = $('<label></label>');
                                    var $input = $('<input type="' + inputType + '" name="answer' + questionItem.qa_id + '">').val(answerItem.ans_id);
                    
                                    $label.append($input).append(answerItem.answer);
                                    $questionContainer.append('<br>').append($label);
                                });
                    
                                $questions.append($questionContainer).append('<br>');
                            });
                        });
                    
                        $('#questions').html($questions);
                        enableSubmitButton(); // Call function to set initial state of submit button
                    }
                    
                    
                
                    $('#submitButton').click(function() {
                        var qa_array = [];
                    
                        $('#satisfactions_q span').each(function() {
                            var satisfactionId = $(this).attr('value');
                            var selectedAnswers = [];
                            if (satisfactionId === '7') {
                                // เก็บข้อมูลช่องกรอกข้อความสำหรับคำถามที่ 7
                                var textAnswer = $('input[name="answer' + satisfactionId + '"]').val();
                                if (textAnswer) {
                                    var qa_answers = {
                                        'q_id': satisfactionId,
                                        'a_id': [textAnswer]
                                    };
                                    qa_array.push(qa_answers);
                                }
                            } else {
                                // เก็บข้อมูลคำตอบที่เลือกสำหรับคำถามที่เป็น radio buttons
                                $('#satisfactions_q input[name="answer' + satisfactionId + '"]:checked').each(function() {
                                    selectedAnswers.push($(this).val());
                                });
                                
                                if (selectedAnswers.length > 0) {
                                    var qa_answers ={
                                        'q_id': satisfactionId,
                                        'a_id': selectedAnswers
                                    };
                                    qa_array.push(qa_answers);
                                }
                            }
                        });
                    
                        var formatJson = {
                            "satisfaction_list": qa_array
                        };
                    
                        console.log(JSON.stringify(formatJson));
                        
                        $.ajax({
                            url: apiUrl+'satisfaction_transaction', //ตรวจสอบให้แน่ใจว่า apiUrl ถูกตั้งค่าอย่างถูกต้อง
                            method: 'POST',
                            dataType: 'json',
                            contentType: 'application/json',
                            data: JSON.stringify(formatJson)
                        }).done(function(response) {
                            console.log(response);
                            alert('Success');
                        }).fail(function(xhr, status, error) {
                            console.error("AJAX Error: ", status, error);
                        });
                        
                        return false;
                    });                              
                });
                
            </script>
        </body>
</html>





