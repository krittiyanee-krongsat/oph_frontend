<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QA</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    
    <label id="question_2_student"></label><br/><br/>

    <label id="question_2_parent"></label><br/><br/>
    
    <div id="ansDropdown_2"></div><br/><br/>

    <button id="submitButton">Submit</button>

    <script>
        
       $(document).ready(function() {
        
        // ประกาศค่าให้กำหนดเลือกคำตอบแค่ 0 ถึง 3
        var selectionCount = 0;
        var maxSelections = 1;
        
        // ส่งคำขอ AJAX เพื่อดึงข้อมูลจากฐานข้อมูล
        $.ajax({
            url: "http://localhost:5000/qa_question/2",
            method: 'GET',
            dataType: 'json',
            success: function(data) {
            
            var question_list = data.question_list;

            var $questionStudent = $('#question_2_student');
            var $questionParent = $('#question_2_parent');

            $.each(question_list, function(index, questionItem) {
                        $questionStudent.append(
                            $('<span></span>').val(questionItem.qa_id).text(questionItem.q_student)
                        );

                        $questionParent.append(
                                $('<span></span>').val(questionItem.qa_id).text(questionItem.q_parent)
                        )
                    })
            },
            error: function(xhr, status, error) {
                console.error("AJAX Error: ", status, error);
            }
        });

        $.ajax({
            url: "http://localhost:5000/qa_question/2",
            method: 'GET',
            dataType: 'json',
            success: function(data) {
                // รับค่า answer array
                var answers = data.answers_list[0];
    
                // แสดงผล answer ใน html
                var $dropdown = $('#ansDropdown_2');
                
                // ใช้ฟังก์ชัน $.each ของ jQuery เพื่อวนลูปผ่านอาร์เรย์ answers
                // ประกาศค่าฟังก์ชัน label กับ input
                // index คือดัชนีของแต่ละรายการในอาร์เรย์ answerItem คือค่าของแต่ละรายการในอาร์เรย์
                $.each(answers, function(index, answerItem) {
                    var $label = $('<label></label>');
                    var $input = $('<input type="radio">').val(answerItem.ans_id);
                    
                    
                    $input.on('change', function() {
                        if ($(this).is(':checked')) {
                            if (selectionCount < maxSelections) { //เช็คเงื่อนไขว่าให้เลือกได้แค่ 3 คำตอบ
                                selectionCount++;
                            } else { //ถ้าเกิน 3 คำตอบจะให้ขึ้นว่าคุณสามารถเลือกได้สูงสุดสามตัวเลือกเท่านั้น
                                alert("คุณสามารถเลือกได้สูงสุดสามตัวเลือกเท่านั้น");
                                $(this).prop('checked', false); // ยกเลิกการเลือกถ้าจำนวนที่เลือกเกิน
                            }
                        }
                    });
    
                    $label.append($input).append(answerItem.answer);
                    $dropdown.append($label).append('<br>');
                });
            },
            error: function(xhr, status, error) {
                console.error("AJAX Error: ", status, error);
            }
        });
            
        }); 
            // ฟังการคลิกปุ่ม Submit
            $('#submitButton').click(function() {
                // ดึงข้อมูลจาก form หรือ dropdown
                var qa_id = $('#question_2_student span').val();
                var ans_id = [];
                $('input[type="radio"]:checked').each(function() {
                    ans_id.push($(this).val());
                });

                console.log(qa_id)
                console.log(ans_id)
                
                    $.ajax({
                    url: 'http://localhost:5000/qa_transaction',
                    method: 'POST',
                    dataType: 'json', //datatype ที่ส่งมาเป็นรูปแบบ json
                    data: {
                        qa_id:qa_id,
                        ans_id: ans_id.join(','),

                    }
                }).always(function (response) {
                    console.log(response);
                    alert('success');
                })
                return false;
            });

    </script>

</body>
</html>